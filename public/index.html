<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notas</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

  <script defer src="https://unpkg.com/alpinejs@3/dist/cdn.min.js"></script>
</head>

<body>

  <div class="container-fluid my-3" x-data="notesApp()" x-init="init()">

    <div class="row align-items-center">
      <div class="col">
        <h1>Bienvenido</h1>
        <p>Esta es una API simple para gestionar notas.</p>
      </div>

      <div class="col text-end">
        <!-- Login -->
        <a x-show="!loggedIn && !loading" class="btn btn-primary"
          href="https://github.com/login/oauth/authorize?client_id=Ov23ctUt77NuStUcvwJn&scope=read:user">
          Login con GitHub
        </a>

        <!-- Logout -->
        <button x-show="loggedIn" class="btn btn-outline-primary" @click="logout">
          <i class="bi bi-x"></i>
          Cerrar Sesión
        </button>
      </div>
    </div>

    <!-- Loading -->
    <div x-show="loading" class="mt-3 text-center" x-transition>
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <!-- Grades -->
    <div class="card shadow-sm my-3" x-show="loggedIn && !loading && grades" x-transition>

      <!-- Header -->
      <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-center">
        <h5 class="my-2">
          <span x-text="$data.grades.Apellido"></span>,
          <span x-text="$data.grades.Nombre"></span>
        </h5>

        <!-- Links -->
        <div class="d-flex justify-content-center gap-2">
          <a
            :href="'https://github.com/' + $data.grades.Usuario" 
            target="_blank" 
            class="btn btn-link"
          >
            <i class="bi bi-github"></i> Github
          </a>
          <a 
            :href="$data.grades.Repo" 
            target="_blank" 
            class="btn btn-link"
          >
            <i class="bi bi-folder"></i> Repo
          </a>
          <a 
            :href="$data.grades.Pages" 
            target="_blank" 
            class="btn btn-link"
          >
            <i class="bi bi-globe"></i> Pages
          </a>
        </div>

      </div>

      <!-- Body -->
      <div class="card-body d-flex flex-column gap-3">

        <!-- Grades Table -->
        <div class="table-responsive">
          <table class="table table-bordered align-middle text-center my-0">
            <thead>
              <tr>
                <th scope="col" colspan="3">1er Cuatrimestre</th>
                <th scope="col" colspan="3">2do Cuatrimestre</th>
                <th scope="col" colspan="3">Intensificación</th>
                <th scope="col" colspan="2">Final</th>
              </tr>
              <tr>
                <th scope="col">Informe</th>
                <th scope="col">Nota</th>
                <th scope="col">Presentismo</th>
                <th scope="col">Informe</th>
                <th scope="col">Nota</th>
                <th scope="col">Presentismo</th>
                <th scope="col">1era instancia</th>
                <th scope="col">2da instancia</th>
                <th scope="col">Nota</th>
                <th scope="col">Nota</th>
                <th scope="col">Presentismo</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <!-- 1er Cuatrimestre Informe -->
                <td x-text="$data.grades['1er Cuatrimestre Informe']"></td>

                <!-- 1er Cuatrimestre Nota -->
                <td x-text="$data.grades['1er Cuatrimestre']"></td>

                <!-- 1er Cuatrimestre Presentismo -->
                <td x-text="$data.grades['1er Cuatrimestre Presentismo']"></td>

                <!-- 2do Cuatrimestre Informe -->
                <td x-text="$data.grades['2do Cuatrimestre Informe']"></td>

                <!-- 2do Cuatrimestre Nota -->
                <td x-text="$data.grades['2do Cuatrimestre']"></td>

                <!-- 2do Cuatrimestre Presentismo -->
                <td x-text="$data.grades['2do Cuatrimestre Presentismo']"></td>

                <!-- Intensificación 1era instancia -->
                <td x-text="$data.grades['Intensificación 1era instancia']"></td>

                <!-- Intensificación 2da instancia -->
                <td x-text="$data.grades['Intensificación 2da instancia']"></td>

                <!-- Intensificación Final -->
                <td x-text="$data.grades['Intensificación Final']"></td>

                <!-- Final Nota -->
                <td x-text="$data.grades['Final Nota']"></td>

                <!-- Final Presentismo -->
                <td x-text="$data.grades['Final Presentismo']"></td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Trabajos Prácticos Table -->
        <div class="table-responsive" x-show="trabajosPracticos().length">
          <table class="table table-bordered align-middle text-center my-0">
            <thead>
              <tr>
                <th scope="col">Trabajo Práctico</th>
                <th scope="col">Resultado</th>
                <th scope="col">Comentarios</th>
              </tr>
            </thead>
            <tbody>
              <template x-for="tp in trabajosPracticos()" :key="tp.id">
                <tr>
                  <td x-text="tp.trabajo"></td>
                  <td x-text="tp.resultado"></td>
                  <td x-text="tp.comentarios"></td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </div>


  </div>

  <script>
    function notesApp() {
      return {
        loading: true,
        error: null,
        loggedIn: false,
        user: null,
        grades: null,

        trabajosPracticos() {
          if (!this.grades) return [];
          const rows = [];
          for (let i = 1; i <= 15; i++) {
            const trabajoKey = `TP ${i}`;

            if (this.grades[trabajoKey]) {
              rows.push({
                id: i,
                trabajo: trabajoKey,
                resultado: this.grades[trabajoKey],
              });
            }
          }
          return rows;
        },

        async init() {
          await this.checkAuth();

          if (this.loggedIn) {
            await this.fetchGrades();
          }

          this.loading = false;
        },

        async checkAuth() {
          const res = await fetch("/auth/github/user");

          if (!res.ok) {
            this.loggedIn = false;
            return;
          }

          this.user = await res.json();
          this.loggedIn = true;
        },

        async fetchGrades() {
          const res = await fetch("/api/grades");

          if (res.status === 401) {
            this.loggedIn = false;
            return;
          }

          if (!res.ok) {
            this.error = "Error al obtener las notas";
            return;
          }

          this.grades = await res.json();
        },

        async logout() {
          await fetch("/auth/github/logout", { method: "POST" });
          location.reload();
        }
      };
    }
  </script>

</body>

</html>