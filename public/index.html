<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notas</title>

  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
    rel="stylesheet"
  >

  <script defer src="https://unpkg.com/alpinejs@3/dist/cdn.min.js"></script>
</head>
<body>

<div class="container my-5" x-data="notesApp()" x-init="init()">

  <h1>Bienvenido</h1>
  <p>Esta es una API simple para gestionar notas.</p>

  <!-- Login -->
  <a
    x-show="!loggedIn && !loading"
    class="btn btn-primary"
    href="https://github.com/login/oauth/authorize?client_id=Ov23ctUt77NuStUcvwJn&scope=read:user"
  >
    Login con GitHub
  </a>

  <!-- Logout -->
  <button
    x-show="loggedIn"
    class="btn btn-danger"
    @click="logout"
  >
    Cerrar sesión
  </button>

  <!-- Loading -->
  <div x-show="loading" class="mt-3">
    Cargando…
  </div>

  <!-- Grades -->
  <pre x-show="loggedIn" x-text="JSON.stringify(grades, null, 2)"></pre>

</div>

<script>
function notesApp() {
  return {
    loading: true,
    loggedIn: false,
    user: null,
    grades: null,

    async init() {
      await this.checkAuth();

      if (this.loggedIn) {
        await this.fetchGrades();
      }

      this.loading = false;
    },

    async checkAuth() {
      const res = await fetch("/auth/github/user", {
        credentials: "include"
      });

      if (!res.ok) {
        this.loggedIn = false;
        return;
      }

      this.user = await res.json();
      this.loggedIn = true;
    },

    async fetchGrades() {
      const res = await fetch("/api/grades", {
        credentials: "include"
      });

      if (res.status === 401) {
        this.loggedIn = false;
        return;
      }

      this.grades = await res.json();
    },

    async logout() {
      await fetch("/auth/github/logout", { method: "POST" });
      location.reload();
    }
  };
}
</script>

</body>
</html>