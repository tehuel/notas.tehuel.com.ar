<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notas Plataformas Móviles - notas.tehuel.com.ar</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

  <script defer src="https://unpkg.com/alpinejs@3/dist/cdn.min.js"></script>
</head>

<body class="bg-light d-flex flex-column min-vh-100">
  <div class="container-fluid my-3" x-data="notesApp()" x-init="init()">

    <!-- Header -->
    <div class="row align-items-center g-3">
      <div class="col-12 col-sm-auto">
        <img src="/logo.svg" alt="Logo" height="48">
      </div>
      <div class="col">
        <h1 class="my-0 h2">Bienvenido</h1>
        <p class="my-0 lead">Consultá tu reporte de notas para Plataformas Móviles.</p>
      </div>

      <div class="col-12 col-sm-auto text-end">
        <!-- Login -->
        <button x-show="!loggedIn" class="btn btn-dark" @click="login" :disabled="loading">
          
          <i class="bi bi-github"></i>
          Login con GitHub
        </button>

        <!-- Logout -->
        <button x-show="loggedIn" class="btn btn-outline-primary" @click="logout" :disabled="loading">
          <i class="bi bi-x"></i>
          Cerrar Sesión
        </button>
      </div>
    </div>

    <!-- Loading -->
    <template x-if="loading">
      <div class="mt-3 text-center">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
    </template>

    <!-- Error -->
    <template x-if="error">
      <div class="alert alert-danger my-3" role="alert" x-text="error"></div>
    </template>

    <!-- Grades Card -->
    <template x-if="$data.loggedIn && !$data.loading && $data.grades">
      <div class="card shadow-sm my-3">

        <!-- Header -->
        <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-center">
          <h5 class="my-2">
            <span x-text="$data.grades?.Apellido"></span>,
            <span x-text="$data.grades?.Nombre"></span>
          </h5>

          <!-- Links -->
          <div class="d-flex justify-content-center gap-2">
            <a :href="'https://github.com/' + $data.grades?.Usuario" target="_blank" class="btn btn-link">
              <i class="bi bi-github"></i> Github
            </a>
            <a :href="$data.grades?.Repo" target="_blank" class="btn btn-link">
              <i class="bi bi-folder"></i> Repo
            </a>
            <a :href="$data.grades?.Pages" target="_blank" class="btn btn-link">
              <i class="bi bi-globe"></i> Pages
            </a>
          </div>

        </div>

        <!-- Body -->
        <div class="card-body d-flex flex-column gap-3">

          <!-- Grades Table -->
          <div class="table-responsive">
            <table class="table table-bordered align-middle text-center my-0">
              <thead>
                <tr>
                  <th scope="col" colspan="3">1er Cuatrimestre</th>
                  <th scope="col" colspan="3">2do Cuatrimestre</th>
                  <th scope="col" colspan="3">Intensificación</th>
                  <th scope="col" colspan="2">Final</th>
                </tr>
                <tr>
                  <th scope="col">Informe</th>
                  <th scope="col">Nota</th>
                  <th scope="col">Presentismo</th>
                  <th scope="col">Informe</th>
                  <th scope="col">Nota</th>
                  <th scope="col">Presentismo</th>
                  <th scope="col">1era instancia</th>
                  <th scope="col">2da instancia</th>
                  <th scope="col">Nota</th>
                  <th scope="col">Nota</th>
                  <th scope="col">Presentismo</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <!-- 1er Cuatrimestre Informe -->
                  <td x-text="$data.grades['1er Cuatrimestre Informe']"></td>

                  <!-- 1er Cuatrimestre Nota -->
                  <td x-text="$data.grades['1er Cuatrimestre']"></td>

                  <!-- 1er Cuatrimestre Presentismo -->
                  <td x-text="$data.grades['1er Cuatrimestre Presentismo']"></td>

                  <!-- 2do Cuatrimestre Informe -->
                  <td x-text="$data.grades['2do Cuatrimestre Informe']"></td>

                  <!-- 2do Cuatrimestre Nota -->
                  <td x-text="$data.grades['2do Cuatrimestre']"></td>

                  <!-- 2do Cuatrimestre Presentismo -->
                  <td x-text="$data.grades['2do Cuatrimestre Presentismo']"></td>

                  <!-- Intensificación 1era instancia -->
                  <td x-text="$data.grades['Intensificación 1era instancia']"></td>

                  <!-- Intensificación 2da instancia -->
                  <td x-text="$data.grades['Intensificación 2da instancia']"></td>

                  <!-- Intensificación Final -->
                  <td x-text="$data.grades['Intensificación Final']"></td>

                  <!-- Final Nota -->
                  <td x-text="$data.grades['Final Nota']"></td>

                  <!-- Final Presentismo -->
                  <td x-text="$data.grades['Final Presentismo']"></td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Trabajos Prácticos Table -->
          <div class="table-responsive" x-show="trabajosPracticos.length">
            <table class="table table-bordered align-middle text-center my-0">
              <thead>
                <tr>
                  <th scope="col">Trabajo Práctico</th>
                  <th scope="col">Resultado</th>
                  <th scope="col">Comentarios</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="tp in trabajosPracticos" :key="tp.id">
                  <tr>
                    <td x-text="tp.trabajo"></td>
                    <td x-text="tp.resultado"></td>
                    <td x-text="tp.comentarios"></td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </template>
  </div>

  <!-- Footer -->
  <div class="mt-auto">
    <footer class="bg-dark text-white text-center py-3">
      <div class="container">
        &copy; 2026 notas.tehuel.com.ar |
        <a href="https://github.com/tehuel/notas.tehuel.com.ar" class="text-white">Código Fuente</a>
      </div>
    </footer>
  </div>

  <script>
    const TP_COUNT = 15;
    const GITHUB_CLIENT_ID = "Ov23ctUt77NuStUcvwJn";
    const GITHUB_LOGIN_URL = `https://github.com/login/oauth/authorize?client_id=${GITHUB_CLIENT_ID}&scope=read:user`;

    function notesApp() {
      return {
        loading: true,
        error: null,
        loggedIn: false,
        user: null,
        grades: null,

        get trabajosPracticos() {
          if (!this.grades) return [];

          const rows = [];
          for (let i = 1; i <= TP_COUNT; i++) {
            const trabajoKey = `TP ${i}`;

            if (this.grades[trabajoKey]) {
              rows.push({
                id: i,
                trabajo: trabajoKey,
                resultado: this.grades[trabajoKey],
              });
            }
          }
          return rows;
        },

        async init() {
          await this.checkAuth();

          if (this.loggedIn) {
            await this.fetchGrades();
          }

          this.loading = false;
        },

        async checkAuth() {
          const res = await fetch("/auth/github/user");

          if (!res.ok) {
            this.loggedIn = false;
            return;
          }

          this.user = await res.json();
          this.loggedIn = true;
        },

        async fetchGrades() {
          this.error = null;
          const res = await fetch("/api/grades");

          if (res.status === 401) {
            this.loggedIn = false;
            return;
          }

          if (res.status === 404) {
            this.error = "No se encontraron datos para este alumno.";
            return;
          }

          if (!res.ok) {
            this.error = "Error al obtener datos.";
            return;
          }

          this.grades = await res.json();
        },

        login() {
          this.loading = true;
          window.location.href = GITHUB_LOGIN_URL;
        },

        async logout() {
          await fetch("/auth/github/logout", { method: "POST" });
          location.reload();
        }
      };
    }
  </script>
</body>
</html>