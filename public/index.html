<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notas</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">

  <script defer src="https://unpkg.com/alpinejs@3/dist/cdn.min.js"></script>
</head>

<body>

  <div class="container-fluid my-3" x-data="notesApp()" x-init="init()">

    <div class="row align-items-center">
      <div class="col">
        <h1>Bienvenido</h1>
        <p>Esta es una API simple para gestionar notas.</p>
      </div>

      <div class="col text-end">
        <!-- Login -->
        <a x-show="!loggedIn && !loading" class="btn btn-primary"
          href="https://github.com/login/oauth/authorize?client_id=Ov23ctUt77NuStUcvwJn&scope=read:user">
          Login con GitHub
        </a>

        <!-- Logout -->
        <button x-show="loggedIn" class="btn btn-danger" @click="logout">
          Cerrar sesi√≥n
        </button>
      </div>
    </div>

    <!-- Loading -->
    <div x-show="loading" class="mt-3 text-center" x-transition>
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
    </div>

    <!-- Grades -->
    <div class="card shadow my-3" x-show="loggedIn && !loading && grades" x-transition>

      <!-- Header -->
      <div class="card-header">
        <h5 class="my-2">
          <span x-text="$data.grades.Apellido"></span>,
          <span x-text="$data.grades.Nombre"></span>
        </h5>
      </div>

      <!-- Body -->
      <div class="card-body">

        <!-- Horizontal Nav -->
        <div class="d-flex justify-content-center mb-3 gap-2">
          <a
            :href="'https://github.com/' + $data.grades.Usuario" 
            target="_blank" 
            class="btn btn-outline-primary"
          >
            <i class="bi bi-github"></i> Github
          </a>
          <a 
            :href="$data.grades.Repo" 
            target="_blank" 
            class="btn btn-outline-primary"
          >
            <i class="bi bi-folder"></i> Repositorio
          </a>
          <a 
            :href="$data.grades.Pages" 
            target="_blank" 
            class="btn btn-outline-primary"
          >
            <i class="bi bi-globe"></i> Github Pages
          </a>
        </div>

        <p>Asistencia: <span x-text="$data.grades.Presentismo"></span></p>

        <pre x-text="JSON.stringify($data.grades, null, 2)"></pre>

      </div>
    </div>


  </div>

  <script>
    function notesApp() {
      return {
        loading: true,
        error: null,
        loggedIn: false,
        user: null,
        grades: null,

        async init() {
          await this.checkAuth();

          if (this.loggedIn) {
            await this.fetchGrades();
          }

          this.loading = false;
        },

        async checkAuth() {
          const res = await fetch("/auth/github/user");

          if (!res.ok) {
            this.loggedIn = false;
            return;
          }

          this.user = await res.json();
          this.loggedIn = true;
        },

        async fetchGrades() {
          const res = await fetch("/api/grades");

          if (res.status === 401) {
            this.loggedIn = false;
            return;
          }

          if (!res.ok) {
            this.error = "Error al obtener las notas";
            return;
          }

          this.grades = await res.json();
        },

        async logout() {
          await fetch("/auth/github/logout", { method: "POST" });
          location.reload();
        }
      };
    }
  </script>

</body>

</html>