<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notas Plataformas Móviles - notas.tehuel.com.ar</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.8/dist/lumen/bootstrap.min.css">

  <style>
    /* Evitar parpadeos al cargar */
    [x-cloak] { display: none !important; }
  </style>

  <script defer src="https://unpkg.com/alpinejs@3/dist/cdn.min.js"></script>
</head>

<body class="bg-light d-flex flex-column min-vh-100">
  <div class="container-fluid my-3" x-data="notesApp()" x-init="init()">

    <!-- Header -->
    <div class="row align-items-center g-3">
      <div class="col-auto">
        <img src="/logo.svg" alt="Logo" height="48">
      </div>
      <div class="col">
        <h1 class="my-0 h2">Bienvenido</h1>
        <p class="my-0 lead">Consultá tu reporte de notas para Plataformas Móviles.</p>
      </div>

      <div class="col-12 col-sm-auto text-end">
        <!-- Login -->
        <a x-cloak x-show="!loggedIn" class="btn btn-dark" :class="{ 'disabled': loading }" @click="loading = true" href="https://github.com/login/oauth/authorize?client_id=<%= githubClientId %>&scope=read:user">
          <i class="bi bi-github"></i>
          Login con GitHub
        </a>

        <!-- Logout -->
        <button x-cloak x-show="loggedIn" class="btn btn-link" @click="logout" :disabled="loading">
          <i class="bi bi-x-circle"></i>
          Cerrar Sesión
        </button>
      </div>
    </div>

    <!-- Loading -->
    <template x-if="loading">
      <div class="mt-3 text-center">
        <div class="spinner-border" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
      </div>
    </template>

    <!-- Error -->
    <template x-if="error">
      <div class="alert alert-danger my-3" role="alert" x-text="error"></div>
    </template>

    <!-- Grades Card -->
    <template x-if="$data.loggedIn && !$data.loading && $data.grades">
      <div class="card shadow-sm my-3">

        <!-- Header -->
        <div class="card-header d-flex flex-column flex-md-row justify-content-between align-items-center">
          <h5 class="my-2">
            <span x-text="$data.grades?.Apellido"></span>,
            <span x-text="$data.grades?.Nombre"></span>
          </h5>

          <!-- Links -->
          <div class="d-flex justify-content-center gap-2">
            <a :href="'https://github.com/' + $data.grades?.Usuario" target="_blank" class="btn btn-link">
              <i class="bi bi-github"></i> Github
            </a>
            <a :href="$data.grades?.Repo" target="_blank" class="btn btn-link">
              <i class="bi bi-folder"></i> Repo
            </a>
            <a :href="$data.grades?.Pages" target="_blank" class="btn btn-link">
              <i class="bi bi-globe"></i> Pages
            </a>
          </div>

        </div>

        <!-- Body -->
        <div class="card-body d-flex flex-column gap-3">

          <!-- Grades Cards (Vertical Layout) -->
          <div class="row g-3">
            <div class="col-12 col-lg-6">
              <div class="card h-100">
                <div class="card-header fw-semibold">1er Cuatrimestre</div>
                <ul class="list-group list-group-flush">
                  <li class="list-group-item d-flex justify-content-between">
                    <span>Informe</span>
                    <span x-text="$data.grades['1er Informe']"></span>
                  </li>
                  <li class="list-group-item d-flex justify-content-between">
                    <span>Nota</span>
                    <span x-text="$data.grades['1er Cuatrimestre']"></span>
                  </li>
                  <li class="list-group-item d-flex justify-content-between">
                    <span>Presentismo</span>
                    <span x-text="$data.grades['1er Presentismo']"></span>
                  </li>
                </ul>
              </div>
            </div>

            <div class="col-12 col-lg-6">
              <div class="card h-100">
                <div class="card-header fw-semibold">2do Cuatrimestre</div>
                <ul class="list-group list-group-flush">
                  <li class="list-group-item d-flex justify-content-between">
                    <span>Informe</span>
                    <span x-text="$data.grades['2do Informe']"></span>
                  </li>
                  <li class="list-group-item d-flex justify-content-between">
                    <span>Nota</span>
                    <span x-text="$data.grades['2do Cuatrimestre']"></span>
                  </li>
                  <li class="list-group-item d-flex justify-content-between">
                    <span>Presentismo</span>
                    <span x-text="$data.grades['2do Presentismo']"></span>
                  </li>
                </ul>
              </div>
            </div>

            <div class="col-12 col-lg-6" :class="{ 'opacity-50': true }">
              <div class="card h-100">
                <div class="card-header fw-semibold">Intensificación</div>
                <ul class="list-group list-group-flush">
                  <li class="list-group-item d-flex justify-content-between">
                    <span>1era instancia</span>
                    <span x-text="$data.grades['Intensificación 1']"></span>
                  </li>
                  <li class="list-group-item d-flex justify-content-between">
                    <span>2da instancia</span>
                    <span x-text="$data.grades['Intensificación 2']"></span>
                  </li>
                  <li class="list-group-item d-flex justify-content-between">
                    <span>Nota</span>
                    <span x-text="$data.grades['Intensificación Final']"></span>
                  </li>
                </ul>
              </div>
            </div>

            <div class="col-12 col-lg-6">
              <div class="card h-100">
                <div class="card-header fw-semibold">Final</div>
                <ul class="list-group list-group-flush">
                  <li class="list-group-item d-flex justify-content-between">
                    <span>Nota</span>
                    <span x-text="$data.grades['Final']"></span>
                  </li>
                  <li class="list-group-item d-flex justify-content-between">
                    <span>Presentismo</span>
                    <span x-text="$data.grades['Final Presentismo']"></span>
                  </li>
                </ul>
              </div>
            </div>
          </div>

          <!-- Trabajos Prácticos Table -->
          <div class="table-responsive" x-show="trabajosPracticos.length">
            <table class="table table-bordered align-middle text-center my-0">
              <thead>
                <tr>
                  <th scope="col">Trabajo Práctico</th>
                  <th scope="col">Resultado</th>
                  <th scope="col">Comentarios</th>
                </tr>
              </thead>
              <tbody>
                <template x-for="tp in trabajosPracticos" :key="tp.id">
                  <tr>
                    <td x-text="tp.trabajo"></td>
                    <td x-text="tp.resultado"></td>
                    <td x-text="tp.comentarios"></td>
                  </tr>
                </template>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </template>
  </div>

  <!-- Footer -->
  <div class="mt-auto">
    <footer class="bg-primary bg-gradient text-white text-center py-5">
      <div class="container d-flex flex-column flex-md-row justify-content-center gap-3">
        <span>&copy; 2026 notas.tehuel.com.ar</span>
        <a target="_blank" rel="noopener noreferrer" href="https://github.com/tehuel/notas.tehuel.com.ar" class="text-white">Código Fuente</a>
        <a target="_blank" rel="noopener noreferrer" href="https://docs.google.com/forms/d/e/1FAIpQLSeWBg9srr97tEeX95B7O6hiRlItU8YBNNbKxFVWrDVM8gJq7g/viewform?usp=publish-editor" class="text-white">Enviar Comentario</a>
        <span><%= version %></span>
      </div>
    </footer>
  </div>

  <script>
    const TP_COUNT = 15;

    function notesApp() {
      return {
        loading: true,
        error: null,
        loggedIn: false,
        user: null,
        grades: null,

        get trabajosPracticos() {
          if (!this.grades) return [];

          const rows = [];
          for (let i = 1; i <= TP_COUNT; i++) {
            const trabajoKey = `TP ${i}`;

            if (this.grades[trabajoKey]) {
              rows.push({
                id: i,
                trabajo: trabajoKey,
                resultado: this.grades[trabajoKey],
              });
            }
          }
          return rows;
        },

        async init() {
          await this.checkAuth();

          if (this.loggedIn) {
            await this.fetchGrades();
          }

          this.loading = false;
        },

        async checkAuth() {
          const res = await fetch("/auth/github/user");

          if (!res.ok) {
            this.loggedIn = false;
            return;
          }

          this.user = await res.json();
          this.loggedIn = true;
        },

        async fetchGrades() {
          this.error = null;
          const res = await fetch("/api/grades");

          if (res.status === 401) {
            this.loggedIn = false;
            return;
          }

          if (res.status === 404) {
            this.error = "No se encontraron datos para este alumno.";
            return;
          }

          if (!res.ok) {
            this.error = "Error al obtener datos.";
            return;
          }

          this.grades = await res.json();
        },

        async logout() {
          await fetch("/auth/github/logout", { method: "POST" });
          location.reload();
        }
      };
    }
  </script>
</body>
</html>
